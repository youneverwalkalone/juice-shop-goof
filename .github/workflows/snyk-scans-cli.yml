name: Snyk Full Platform (CLI)

# Prerequisites:
# - Set a SNYK_TOKEN under env secrets in an env called "Snyk"
# - If you are not running the scan on your default org in Snyk, set the org id in a secret called SNYK_ORG in the same env as above (env called "Snyk") and add an additional --org=${{ secrets.SNYK_ORG }} parameter in all the test commands 

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:

  snyk-os:
    environment: snyk
    runs-on: ubuntu-latest
    outputs:
      exit_code: ${{ steps.snyk_oss_test.outcome }}
    steps:
      - uses: actions/checkout@master
      
      - name: Install Snyk CLI
        run: |
          wget -O snyk https://static.snyk.io/cli/latest/snyk-linux
          chmod +x ./snyk
          mv ./snyk /usr/local/bin/
          
      - name: Configure Snyk for AU region
        run: |
          snyk config set endpoint=https://app.au.snyk.io/api
          snyk config set use-base64-encoding=true
          echo "âœ… Snyk configured for AU region"
          
      - name: Authenticate Snyk
        run: snyk auth ${{ secrets.SNYK_TOKEN }}
        
      - name: Install dependencies
        run: npm install
        
      - name: Run Snyk Open Source Test
        id: snyk_oss_test
        continue-on-error: true
        run: snyk test --severity-threshold=high
        
      - name: Monitor Snyk Open Source
        if: github.event_name == 'push'
        run: snyk monitor

  snyk-code:
    environment: snyk
    runs-on: ubuntu-latest
    outputs:
      exit_code: ${{ steps.snyk_code_test.outcome }}
    steps:
      - uses: actions/checkout@master
      
      - name: Install Snyk CLI
        run: |
          wget -O snyk https://static.snyk.io/cli/latest/snyk-linux
          chmod +x ./snyk
          mv ./snyk /usr/local/bin/
          
      - name: Configure Snyk for AU region
        run: |
          snyk config set endpoint=https://app.au.snyk.io/api
          snyk config set use-base64-encoding=true
          echo "âœ… Snyk configured for AU region"
          
      - name: Authenticate Snyk
        run: snyk auth ${{ secrets.SNYK_TOKEN }}
        
      - name: Run Snyk Code Test
        id: snyk_code_test
        continue-on-error: true
        run: snyk code test --severity-threshold=high

  snyk-container:
    environment: snyk
    runs-on: ubuntu-latest
    outputs:
      exit_code: ${{ steps.snyk_container_test.outcome }}
    steps:
      - uses: actions/checkout@master
      
      - name: Build the Docker image
        id: docker_build
        run: |
          # Build image with tag
          IMAGE_NAME="${{ github.repository }}:${{ github.sha }}"
          
          echo "ğŸ³ Building Docker image..."
          docker build -t "${IMAGE_NAME}" .
          
          echo "image_name=${IMAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "âœ… Image built: ${IMAGE_NAME}"
          
      - name: Install Snyk CLI
        run: |
          wget -O snyk https://static.snyk.io/cli/latest/snyk-linux
          chmod +x ./snyk
          mv ./snyk /usr/local/bin/
          
      - name: Configure Snyk for AU region
        run: |
          snyk config set endpoint=https://app.au.snyk.io/api
          snyk config set use-base64-encoding=true
          echo "âœ… Snyk configured for AU region"
          
      - name: Authenticate Snyk
        run: snyk auth ${{ secrets.SNYK_TOKEN }}
        
      - name: Scan Docker Container
        id: snyk_container_test
        continue-on-error: true
        run: |
          IMAGE_NAME="${{ steps.docker_build.outputs.image_name }}"
          snyk container test ${IMAGE_NAME} --file=Dockerfile --severity-threshold=high
          
      - name: Monitor Docker Container
        if: github.event_name == 'push'
        run: |
          IMAGE_NAME="${{ steps.docker_build.outputs.image_name }}"
          snyk container monitor ${IMAGE_NAME} --file=Dockerfile
     
  snyk-iac:
    environment: snyk
    runs-on: ubuntu-latest
    outputs:
      exit_code: ${{ steps.snyk_iac_test.outcome }}
    steps:
      - uses: actions/checkout@master
      
      - name: Install Snyk CLI
        run: |
          wget -O snyk https://static.snyk.io/cli/latest/snyk-linux
          chmod +x ./snyk
          mv ./snyk /usr/local/bin/
          
      - name: Configure Snyk for AU region
        run: |
          snyk config set endpoint=https://app.au.snyk.io/api
          snyk config set use-base64-encoding=true
          echo "âœ… Snyk configured for AU region"
          
      - name: Authenticate Snyk
        run: snyk auth ${{ secrets.SNYK_TOKEN }}
        
      - name: Run Snyk IaC Test
        id: snyk_iac_test
        continue-on-error: true
        run: snyk iac test --report --severity-threshold=high

  security-gate:
    name: Security Gate Check
    runs-on: ubuntu-latest
    needs: [snyk-os, snyk-code, snyk-container, snyk-iac]
    if: always()
    steps:
      - name: Check security scan results
        run: |
          echo "ğŸ” Security Scan Results:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Open Source:  ${{ needs.snyk-os.outputs.exit_code }}"
          echo "Code:         ${{ needs.snyk-code.outputs.exit_code }}"
          echo "Container:    ${{ needs.snyk-container.outputs.exit_code }}"
          echo "IaC:          ${{ needs.snyk-iac.outputs.exit_code }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [[ "${{ needs.snyk-os.outputs.exit_code }}" == "failure" ]] || \
             [[ "${{ needs.snyk-code.outputs.exit_code }}" == "failure" ]] || \
             [[ "${{ needs.snyk-container.outputs.exit_code }}" == "failure" ]] || \
             [[ "${{ needs.snyk-iac.outputs.exit_code }}" == "failure" ]]; then
            echo ""
            echo "âŒ Security scan found HIGH or CRITICAL severity issues"
            echo ""
            echo "ğŸ” Review the findings at:"
            echo "   https://app.au.snyk.io/org/${{ secrets.SNYK_ORG }}"
            echo ""
            echo "âš ï¸  Please address these security issues before merging."
            exit 1
          else
            echo ""
            echo "âœ… All security scans passed!"
          fi