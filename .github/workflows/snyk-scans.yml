name: Snyk Full Platform

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  setup-snyk:
    name: Setup Snyk CLI
    environment: snyk
    runs-on: ubuntu-latest
    steps:
      - uses: snyk/actions/setup@master
      
      - name: Configure Snyk for AU region
        run: |
          snyk config set endpoint=https://app.au.snyk.io/api
          snyk config set use-base64-encoding=true
          echo "âœ… Snyk configured for AU region"
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          
      - name: Get Snyk config directory
        id: snyk_config
        run: |
          # Find Snyk config file location
          SNYK_CONFIG_DIR="${HOME}/.config/configstore"
          mkdir -p "${SNYK_CONFIG_DIR}"
          echo "config_dir=${SNYK_CONFIG_DIR}" >> "$GITHUB_OUTPUT"
          ls -la "${SNYK_CONFIG_DIR}" || true
          
      - name: Upload Snyk configuration
        uses: actions/upload-artifact@v4
        with:
          name: snyk-config
          path: ~/.config/configstore/
          retention-days: 1
          if-no-files-found: warn

  snyk-os:
    name: Snyk Open Source Scan
    needs: setup-snyk
    environment: snyk
    runs-on: ubuntu-latest
    outputs:
      exit_code: ${{ steps.snyk_os_test.outcome }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          
      - uses: snyk/actions/setup@master
      
      - name: Download Snyk configuration
        uses: actions/download-artifact@v4
        with:
          name: snyk-config
          path: ~/.config/configstore/
        continue-on-error: true
          
      - name: Configure Snyk for AU region
        run: |
          snyk config set endpoint=https://app.au.snyk.io/api
          snyk config set use-base64-encoding=true
          echo "âœ… Snyk configured for AU region"
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          
      - name: Install dependencies
        run: npm install
        
      - name: Snyk Open Source Test
        id: snyk_os_test
        continue-on-error: true
        run: snyk test --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          
      - name: Monitor dependencies for security issues with Snyk
        if: github.event_name == 'push'
        run: snyk monitor
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  snyk-code:
    name: Snyk Code Scan
    needs: setup-snyk
    environment: snyk
    runs-on: ubuntu-latest
    outputs:
      exit_code: ${{ steps.snyk_code_test.outcome }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: snyk/actions/setup@master
      
      - name: Download Snyk configuration
        uses: actions/download-artifact@v4
        with:
          name: snyk-config
          path: ~/.config/configstore/
        continue-on-error: true
      
      - name: Configure Snyk for AU region
        run: |
          snyk config set endpoint=https://app.au.snyk.io/api
          snyk config set use-base64-encoding=true
          echo "âœ… Snyk configured for AU region"
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          
      - name: Snyk Code Test
        id: snyk_code_test
        continue-on-error: true
        run: snyk code test --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  snyk-container:
    name: Snyk Container Scan
    needs: setup-snyk
    environment: snyk
    runs-on: ubuntu-latest
    outputs:
      exit_code: ${{ steps.snyk_container_test.outcome }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: snyk/actions/setup@master
      
      - name: Download Snyk configuration
        uses: actions/download-artifact@v4
        with:
          name: snyk-config
          path: ~/.config/configstore/
        continue-on-error: true
      
      - name: Configure Snyk for AU region
        run: |
          snyk config set endpoint=https://app.au.snyk.io/api
          snyk config set use-base64-encoding=true
          echo "âœ… Snyk configured for AU region"
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          
      - name: Build the Docker image
        run: docker build . --file Dockerfile --tag boosef-juiceshop:latest
        
      - name: Snyk Container Test
        id: snyk_container_test
        continue-on-error: true
        run: snyk container test boosef-juiceshop:latest --file=Dockerfile --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          
      - name: Monitor Docker Container
        if: github.event_name == 'push'
        run: snyk container monitor boosef-juiceshop:latest --file=Dockerfile
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  snyk-iac:
    name: Snyk IaC Scan
    needs: setup-snyk
    environment: snyk
    runs-on: ubuntu-latest
    outputs:
      exit_code: ${{ steps.snyk_iac_test.outcome }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: snyk/actions/setup@master
      
      - name: Download Snyk configuration
        uses: actions/download-artifact@v4
        with:
          name: snyk-config
          path: ~/.config/configstore/
        continue-on-error: true
      
      - name: Configure Snyk for AU region
        run: |
          snyk config set endpoint=https://app.au.snyk.io/api
          snyk config set use-base64-encoding=true
          echo "âœ… Snyk configured for AU region"
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          
      - name: Snyk IaC Test
        id: snyk_iac_test
        continue-on-error: true
        run: snyk iac test --report --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  security-gate:
    name: Security Gate Check
    runs-on: ubuntu-latest
    needs: [snyk-os, snyk-code, snyk-container, snyk-iac]
    if: always()
    steps:
      - name: Check security scan results
        run: |
          echo "ğŸ” Security Scan Results:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Open Source:  ${{ needs.snyk-os.outputs.exit_code }}"
          echo "Code:         ${{ needs.snyk-code.outputs.exit_code }}"
          echo "Container:    ${{ needs.snyk-container.outputs.exit_code }}"
          echo "IaC:          ${{ needs.snyk-iac.outputs.exit_code }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [[ "${{ needs.snyk-os.outputs.exit_code }}" == "failure" ]] || \
             [[ "${{ needs.snyk-code.outputs.exit_code }}" == "failure" ]] || \
             [[ "${{ needs.snyk-container.outputs.exit_code }}" == "failure" ]] || \
             [[ "${{ needs.snyk-iac.outputs.exit_code }}" == "failure" ]]; then
            echo ""
            echo "âŒ Security scan found HIGH or CRITICAL severity issues"
            echo ""
            echo "ğŸ” Review the findings at:"
            echo "   https://app.au.snyk.io"
            echo ""
            echo "âš ï¸  Please address these security issues before merging."
            exit 1
          else
            echo ""
            echo "âœ… All security scans passed!"
          fi